{% extends 'base.html' %}

{% block title %}Hejbni kostrou! - Fitness Aplikace pro Z√°kladn√≠ ≈†kolu{% endblock %}

{% block body_id %}home-page{% endblock %}

{% block content %}
<h1>V√≠tejte v aplikaci ‚ÄûHejbni kostrou!" ü¶¥üèÉ‚Äç‚ôÇÔ∏èü§∏‚Äç‚ôÇÔ∏è</h1>

<div class="menu-container">
    <div class="skolni-rok-container">
        <span>≈†koln√≠ rok:</span>
        <select id="skolniRok" name="skolniRok" class="form-control">
            {% for rok in skolni_roky %}
            <option value="{{ rok.id }}" {% if rok.rok_od==session.vybrany_skolni_rok_od %}selected{% endif %}
                data-rok-od="{{ rok.rok_od }}" data-rok-do="{{ rok.rok_do }}">
                {{ rok.rok_od }}/{{ rok.rok_do }}
            </option>
            {% endfor %}
        </select>
        <button id="updateSkolniRokBtn" class="btn btn-primary">Aktualizovat rok</button>
    </div>
</div>

<div>
    <a href="/zaci" class="button">Seznam ≈æ√°k≈Ø</a>
    <form action="/vyhledat" method="GET" class="search-container" id="searchForm">
        <input type="text" id="searchInput" name="query" placeholder="üîç Vyhledat ≈æ√°ka..." class="search-input"
            autocomplete="off">
    </form>
    <a href="/tridy" class="button">T≈ô√≠dy</a>
    <a href="/zebricky_a_statistiky" class="button">≈Ωeb≈ô√≠ƒçky a statistiky</a>
    <a href="/discipliny" class="button">Discipl√≠ny</a>
    <a href="/odkazy_a_informace" class="button">Odkazy a informace</a>

    <!-- P≈ôid√°n√≠ tlaƒç√≠tka pro import nov√Ωch ≈æ√°k≈Ø -->
    <a href="#" id="importNovychZakuBtn" class="button">Import nov√Ωch ≈æ√°k≈Ø</a>

    <!-- Nov√© tlaƒç√≠tko pro spr√°vu ≈°koln√≠ho roku -->
    <a href="#" id="spravaSkolnihoRokuBtn" class="button admin-button">Spr√°va ≈°koln√≠ho roku</a>
</div>

<div class="headline-container">
    <h2>Pohyb je z√°klad zdrav√©ho ≈æivotn√≠ho stylu, a proto jsme tu! Aplikace je vytvo≈ôena pro √∫ƒçely tƒõlesn√© v√Ωchovy na Z≈†
        Svatopluka ƒåecha Choce≈à a je p≈ôizp≈Øsobena pot≈ôeb√°m uƒçitel≈Ø i ≈æ√°k≈Ø, aby podpo≈ôila dlouhodob√Ω rozvoj pohybov√Ωch
        dovednost√≠.</h2>
</div>

<!-- ‚úÖ Spr√°vn√© rozlo≈æen√≠ obsahu -->
<div class="content-container">
    <!-- Lev√° ƒç√°st s logem -->
    <div class="left-side">
        <div class="logo-hlavni-container">
            <a href="{{ url_for('home') }}">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo aplikace" class="logo-hlavni">
            </a>
        </div>
    </div>

    <!-- Prav√° ƒç√°st s textem -->
    <div class="right-side">
        <div class="info-container">
            <h3>üë¶üëß Pro ≈æ√°ky:</h3>
            <p>Chcete se posouvat vp≈ôed a vidƒõt v√Ωsledky? Jste tu spr√°vnƒõ! Nav√≠c m≈Ø≈æete z√≠sk√°vat body za va≈°i snahu!
                Nez√°le≈æ√≠ na startovn√≠ pozici, d≈Øle≈æit√Ω je pokrok!</p>

            <h3>üßë‚Äçüè´ Pro uƒçitele:</h3>
            <p>Syst√©m v√°m usnadn√≠ evidenci v√Ωkon≈Ø ≈æ√°k≈Ø a jejich monitoring. ≈Ω√°dn√© pap√≠ry<br>a slo≈æit√© p≈ôepoƒçty ‚Äì zde v≈°e
                najdete p≈ôehlednƒõ na jednom m√≠stƒõ.</p>

            <h3>‚¨ÖÔ∏è Co zde najdete?</h3>
            <ul>
                <li><b>Seznam ≈æ√°k≈Ø</b> ‚Äì Rychl√Ω p≈ô√≠stup k v√Ωsledk≈Øm jednotliv√Ωch ≈æ√°k≈Ø.</li>
                <li><b>T≈ô√≠dy</b> ‚Äì P≈ôehled v√Ωkon≈Ø cel√© t≈ô√≠dy.</li>
                <li><b>≈Ωeb≈ô√≠ƒçky a statistiky</b> ‚Äì Statistiky a srovn√°n√≠ nejlep≈°√≠ch v√Ωkon≈Ø.</li>
                <li><b>Discipl√≠ny</b> ‚Äì Seznam, z√°pis a v√Ωsledky v≈°ech discipl√≠n.</li>
                <li><b>Odkazy a informace</b> ‚Äì U≈æiteƒçn√© materi√°ly a dal≈°√≠ informace.</li>
            </ul>

            <h3>‚û°Ô∏è Jak pokraƒçovat?</h3>
            <p>Vyberte si z nab√≠dky a zaƒçnƒõte sledovat sv≈Øj pokrok! üí™</p>
        </div>
    </div>
</div>

<!-- P≈ôidat mod√°ln√≠ okno pro import ≈æ√°k≈Ø p≈ôed konec obsahu -->
<div id="importModal" class="modal">
    <div class="modal-content import-modal-content">
        <span class="close">&times;</span>
        <h2>Import nov√Ωch ≈æ√°k≈Ø 6. roƒçn√≠ku</h2>
        <p>Nahrajte Excel soubor se seznamem nov√Ωch ≈æ√°k≈Ø. Form√°t mus√≠ b√Ωt stejn√Ω jako pro st√°vaj√≠c√≠ ≈æ√°ky.</p>

        <form id="importForm" enctype="multipart/form-data">
            <div class="form-group">
                <label for="excelFile">Vyberte Excel soubor:</label>
                <input type="file" id="excelFile" name="excelFile" accept=".xlsx, .xls" required>
            </div>

            <div class="form-group">
                <button type="submit" class="submit-btn">Importovat ≈æ√°ky</button>
            </div>
        </form>

        <div id="importStatus"></div>
    </div>
</div>

<!-- Nov√© mod√°ln√≠ okno pro spr√°vu ≈°koln√≠ho roku -->
<div id="skolniRokModal" class="modal">
    <div class="modal-content admin-modal-content">
        <span class="close">&times;</span>
        <h2>Spr√°va ≈°koln√≠ho roku</h2>

        <div class="admin-section">
            <h3>Posun ≈æ√°k≈Ø do nov√©ho ≈°koln√≠ho roku</h3>
            <div class="alert alert-warning">
                <strong>Pozor!</strong> Tato operace posune v≈°echny ≈æ√°ky o jeden roƒçn√≠k v√Ω≈°e.
                ≈Ω√°ci z 9. t≈ô√≠d budou oznaƒçeni jako absolventi.
                Tato akce nelze vr√°tit zpƒõt!
            </div>

            <form method="POST" action="{{ url_for('admin_posunout_rocnik') }}" id="posunRocnikForm">
                <div class="form-group">
                    <label for="z_roku_id">Z roku:</label>
                    <select class="form-control" id="z_roku_id" name="z_roku_id" required>
                        <option value="">Vyberte ≈°koln√≠ rok</option>
                        {% for rok in skolni_roky %}
                        <option value="{{ rok.id }}" {% if rok.rok_od==session.vybrany_skolni_rok_od %}selected{% endif
                            %}>
                            {{ rok.rok_od }}/{{ rok.rok_do }} {% if rok.aktualni %}(aktu√°ln√≠){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="do_roku_id">Do roku:</label>
                    <select class="form-control" id="do_roku_id" name="do_roku_id" required>
                        <option value="">Vyberte ≈°koln√≠ rok</option>
                        {% for rok in skolni_roky %}
                        <option value="{{ rok.id }}">
                            {{ rok.rok_od }}/{{ rok.rok_do }} {% if rok.aktualni %}(aktu√°ln√≠){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-danger" id="posunRocnikBtn">
                        Posunout ≈æ√°ky
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Najdeme vyhled√°vac√≠ pole
        let searchInput = document.getElementById("searchInput");

        // Pouze na home str√°nce resetujeme vyhled√°vac√≠ pole
        if (searchInput && document.body.id === "home-page") {
            searchInput.value = ""; // Reset vyhled√°v√°n√≠ jen pro home.html
        }
    });

    window.addEventListener("pageshow", function (event) {
        let searchInput = document.getElementById("searchInput");

        // Pouze pokud jsme na home.html a prohl√≠≈æeƒç naƒçetl str√°nku z cache
        if (searchInput && document.body.id === "home-page" && (event.persisted || window.performance.getEntriesByType("navigation")[0].type === "back_forward")) {
            searchInput.value = "";
        }
    });

    // Nut√≠me prohl√≠≈æeƒç neukl√°dat str√°nku do cache pouze na home.html
    if (document.body.id === "home-page" && "onpageshow" in window) {
        window.onpageshow = function (event) {
            if (event.persisted) {
                location.reload(); // Vynut√≠ opƒõtovn√© naƒçten√≠ str√°nky
            }
        };
    }

    // V DOMContentLoaded event listeneru
    const updateSkolniRokBtn = document.getElementById("updateSkolniRokBtn");
    const skolniRokSelect = document.getElementById("skolniRok");

    if (updateSkolniRokBtn && skolniRokSelect) {
        updateSkolniRokBtn.addEventListener("click", function (e) {
            e.preventDefault();

            const rokId = skolniRokSelect.value;
            const selectedOption = skolniRokSelect.options[skolniRokSelect.selectedIndex];
            const rokOd = selectedOption.getAttribute("data-rok-od");
            const rokDo = selectedOption.getAttribute("data-rok-do");

            // Potvrzovac√≠ dialog
            if (!confirm(`Opravdu chcete zmƒõnit aktivn√≠ ≈°koln√≠ rok na ${rokOd}/${rokDo}?`)) {
                return;
            }

            // Vol√°n√≠ API pro zmƒõnu roku
            fetch("/nastav_aktivni_rok", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ rok_id: rokId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("‚úÖ ≈†koln√≠ rok byl √∫spƒõ≈°nƒõ zmƒõnƒõn na " + rokOd + "/" + rokDo);
                        // Aktualizovat str√°nku
                        location.reload();
                    } else {
                        alert("‚ùå Chyba p≈ôi zmƒõnƒõ ≈°koln√≠ho roku: " + (data.error || "Nezn√°m√° chyba"));
                    }
                })
                .catch(error => {
                    console.error("‚ùå Chyba p≈ôi komunikaci s API:", error);
                    alert("‚ùå Chyba p≈ôi zmƒõnƒõ ≈°koln√≠ho roku: " + error);
                });
        });
    }

    // Reference na modal a jeho prvky
    const modal = document.getElementById("importModal");
    const importBtn = document.getElementById("importNovychZakuBtn");
    const closeBtn = document.querySelector(".close");
    const importForm = document.getElementById("importForm");
    const importStatus = document.getElementById("importStatus");

    // Otev≈ôen√≠ modalu
    importBtn.addEventListener("click", function (e) {
        e.preventDefault();
        modal.style.display = "block";
    });

    // Zav≈ôen√≠ modalu
    closeBtn.addEventListener("click", function () {
        modal.style.display = "none";
        importStatus.style.display = "none";
        importForm.reset();
    });

    // Zav≈ôen√≠ modalu kliknut√≠m mimo jeho obsah
    window.addEventListener("click", function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
            importStatus.style.display = "none";
            importForm.reset();
        }
    });

    // Zpracov√°n√≠ formul√°≈ôe pro import ≈æ√°k≈Ø
    importForm.addEventListener("submit", function (e) {
        e.preventDefault();

        const fileInput = document.getElementById("excelFile");
        if (!fileInput.files[0]) {
            showImportStatus("Vyberte soubor pro import.", "error");
            return;
        }

        const formData = new FormData();
        formData.append("excelFile", fileInput.files[0]);

        // Zpracov√°n√≠ nahr√°v√°n√≠ a importu
        importStatus.innerHTML = "Import prob√≠h√°, ƒçekejte pros√≠m...";
        importStatus.className = "";
        importStatus.style.display = "block";

        fetch("/import_novi_zaci_6_rocniku", {
            method: "POST",
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showImportStatus(data.message || "Import byl √∫spƒõ≈°nƒõ dokonƒçen!", "success");
                } else {
                    showImportStatus(data.error || "P≈ôi importu do≈°lo k chybƒõ.", "error");
                }
            })
            .catch(error => {
                console.error("Chyba p≈ôi importu:", error);
                showImportStatus("P≈ôi importu do≈°lo k technick√© chybƒõ.", "error");
            });
    });

    // Zobrazen√≠ statusu importu
    function showImportStatus(message, type) {
        importStatus.innerHTML = message;
        importStatus.className = type;
        importStatus.style.display = "block";

        if (type === "success") {
            // Po √∫spƒõ≈°n√©m importu resetujeme formul√°≈ô
            setTimeout(() => {
                importForm.reset();
            }, 2000);
        }
    }

    // K√≥d pro mod√°ln√≠ okno spr√°vy ≈°koln√≠ho roku
    const skolniRokModal = document.getElementById("skolniRokModal");
    const spravaSkolnihoRokuBtn = document.getElementById("spravaSkolnihoRokuBtn");
    const closeButtons = document.querySelectorAll(".close");
    const posunRocnikForm = document.getElementById("posunRocnikForm");
    const posunRocnikBtn = document.getElementById("posunRocnikBtn");

    // Otev≈ôen√≠ modalu pro spr√°vu ≈°koln√≠ho roku
    if (spravaSkolnihoRokuBtn) {
        spravaSkolnihoRokuBtn.addEventListener("click", function (e) {
            e.preventDefault();
            skolniRokModal.style.display = "block";
        });
    }

    // Zav≈ôen√≠ v≈°ech mod√°l≈Ø p≈ôi kliknut√≠ na tlaƒç√≠tko zav≈ô√≠t
    closeButtons.forEach(button => {
        button.addEventListener("click", function () {
            document.querySelectorAll(".modal").forEach(modal => {
                modal.style.display = "none";
            });
        });
    });

    // Zav≈ôen√≠ modalu kliknut√≠m mimo jeho obsah
    window.addEventListener("click", function (event) {
        if (event.target.classList.contains("modal")) {
            event.target.style.display = "none";
        }
    });

    // Automatick√Ω v√Ωbƒõr navazuj√≠c√≠ho roku pro posun roƒçn√≠k≈Ø
    const zRokuSelect = document.getElementById("z_roku_id");
    const doRokuSelect = document.getElementById("do_roku_id");

    if (zRokuSelect && doRokuSelect) {
        zRokuSelect.addEventListener("change", function () {
            // Nastaven√≠ n√°sleduj√≠c√≠ho roku jako c√≠lov√©ho
            const selectedIndex = this.selectedIndex;
            if (selectedIndex > 0 && selectedIndex < doRokuSelect.options.length) {
                doRokuSelect.selectedIndex = selectedIndex + 1;
            }
        });
    }

    // Potvrzovac√≠ dialog pro posun roƒçn√≠k≈Ø
    if (posunRocnikBtn) {
        posunRocnikForm.addEventListener("submit", function (e) {
            const confirmMessage = "POZOR! Tato akce posune v≈°echny ≈æ√°ky o jeden roƒçn√≠k v√Ω≈°e a ≈æ√°ci 9. t≈ô√≠d budou oznaƒçeni jako absolventi. Tuto akci nelze vr√°tit zpƒõt.\n\nOpravdu chcete pokraƒçovat?";

            if (!confirm(confirmMessage)) {
                e.preventDefault();
            }
        });
    }
    });
</script>
{% endblock %}