<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#f5f5f5"> <!-- Barva z√°hlav√≠ prohl√≠≈æeƒçe v mobiln√≠ch za≈ô√≠zen√≠ch -->
    <meta name="format-detection" content="telephone=no"> <!-- Zabr√°n√≠ automatick√©mu form√°tov√°n√≠ telefonn√≠ch ƒç√≠sel -->
    <meta name="mobile-web-app-capable" content="yes"> <!-- Pro mo≈ænost p≈ôid√°n√≠ na plochu jako aplikace -->
    <meta name="apple-mobile-web-app-capable" content="yes"> <!-- Pro iOS za≈ô√≠zen√≠ -->
    <title>{% block title %}Hejbni kostrou!{% endblock %}</title>

    <!-- Zmƒõnƒõn√Ω odkaz na CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

    <!-- P≈ôid√°n√≠ odkazu na favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">

    <!-- JavaScript soubory - d≈Øle≈æit√© po≈ôad√≠ -->
    <script src="{{ url_for('static', filename='js/student_performance.js') }}"></script>
</head>

<body id="{% block body_id %}{% endblock %}" data-skolni-rok="{{ session.get('vybrany_skolni_rok_od') }}"
    data-skolni-rok-do="{{ session.get('vybrany_skolni_rok_do') }}">

    <!-- üîπ ≈†koln√≠ rok v prav√©m horn√≠m rohu -->
    <div class="skolni-rok">
        Aktu√°ln√≠ ≈°koln√≠ rok: <strong>{{ session.get('vybrany_skolni_rok_od') }}/{{ session.get('vybrany_skolni_rok_do')
            }}</strong>
    </div>

    <!-- üîπ Logo ‚ÄûDom≈Ø" -->
    <div class="logo-home">
        <a href="{{ url_for('home') }}">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Dom≈Ø">
        </a>
    </div>

    <!-- P≈ôidejte toto do <body> hned za hlaviƒçku -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages">
        {% for category, message in messages %}
        <div class="flash-message {{ category }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- üîπ Hlavn√≠ obsah str√°nky -->
    <div class="page-wrapper">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </div>

    <!-- ‚úÖ Spoleƒçn√© funkce -->
    <script>
        /**
         * Funkce pro zmƒõnu ≈°koln√≠ho roku na serveru
         * @param {string} rokId - ID ≈°koln√≠ho roku 
         * @param {string} rokOd - Prvn√≠ rok ≈°koln√≠ho roku (YYYY)
         * @param {string} rokDo - Druh√Ω rok ≈°koln√≠ho roku (YYYY)
         * @returns {Promise} - Promise pro zpracov√°n√≠ odpovƒõdi
         */
        function zmenitSkolniRok(rokId, rokOd, rokDo) {
            const vybranyRokString = `${rokOd}/${rokDo}`;

            if (!confirm(`Opravdu chcete zmƒõnit ≈°koln√≠ rok na ${vybranyRokString}?`)) {
                return Promise.reject(new Error('U≈æivatel zru≈°il zmƒõnu roku'));
            }

            return fetch('/nastav_aktivni_rok', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ rok_id: rokId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // √öspƒõ≈°nƒõ zmƒõnƒõno - vynut√≠me reload str√°nky
                        window.location.reload();
                        return data;
                    } else {
                        // Chybov√© hl√°≈°en√≠
                        const errorMsg = data.error || "Nezn√°m√° chyba p≈ôi zmƒõnƒõ ≈°koln√≠ho roku";
                        alert("‚ùå " + errorMsg);
                        throw new Error(errorMsg);
                    }
                })
                .catch(err => {
                    console.error("‚ùå Chyba p≈ôi zmƒõnƒõ ≈°koln√≠ho roku:", err);
                    alert("‚ùå Technick√° chyba p≈ôi zmƒõnƒõ ≈°koln√≠ho roku.");
                    throw err;
                });
        }

        // Inicializace p≈ôi naƒçten√≠ str√°nky
        document.addEventListener("DOMContentLoaded", function () {
            // Event listener pro dropdown ≈°koln√≠ho roku
            const skolniRokSelect = document.getElementById("skolniRok");
            if (skolniRokSelect) {
                skolniRokSelect.addEventListener("change", function () {
                    const selectedOption = this.options[this.selectedIndex];
                    const rokId = selectedOption.value;
                    const rokOd = selectedOption.getAttribute('data-rok-od');
                    const rokDo = selectedOption.getAttribute('data-rok-do');

                    zmenitSkolniRok(rokId, rokOd, rokDo)
                        .catch(error => {
                            console.error("Zmƒõna roku byla zru≈°ena nebo selhala:", error);
                        });
                });
            }

            // Optimalizace pro dotykov√© za≈ô√≠zen√≠
            const today = new Date();
            document.body.setAttribute('data-datum', today.toLocaleDateString('cs-CZ'));

            // Zji≈°tƒõn√≠, zda jde o dotykov√© za≈ô√≠zen√≠
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

            if (isTouchDevice) {
                // P≈ôid√°n√≠ t≈ô√≠dy k tƒõlu dokumentu pro CSS √∫pravy
                document.body.classList.add('touch-device');

                // P≈ôizp≈Øsoben√≠ input≈Ø pro numerick√© hodnoty
                const numericInputs = document.querySelectorAll('.discipline-table input, .bonus-table input, .penalty-table input');
                numericInputs.forEach(input => {
                    // Pro numerick√© inputy nastav√≠me numerickou kl√°vesnici
                    if (input.type === 'text' && !input.hasAttribute('pattern')) {
                        input.setAttribute('inputmode', 'decimal');
                    }
                });

                // Obalen√≠ tabulek pro horizont√°ln√≠ scrollov√°n√≠
                const tables = document.querySelectorAll('.discipline-table, .bonus-table, .penalty-table, .grading-table, .student-info-table');
                tables.forEach(table => {
                    // Pokud tabulka je≈°tƒõ nen√≠ v kontejneru pro scrollov√°n√≠
                    if (!table.parentElement.classList.contains('table-container')) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'table-container';
                        table.parentNode.insertBefore(wrapper, table);
                        wrapper.appendChild(table);
                    }
                });
            }
        });
    </script>

    <!-- P≈ôid√°n JavaScript pro mod√°ln√≠ okna -->
    <script src="{{ url_for('static', filename='js/components/modals.js') }}"></script>
</body>

</html>